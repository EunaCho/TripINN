<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="house">

	<!-- house list sql -->
	<select id="selectHouseList" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
			SELECT HOUSE_IDX, HOUSE_NAME, HOUSE_INFO, HOUSE_IMAGE,
					 HOUSE_KIND, HOUSE_ZIPCODE, HOUSE_ADDR1, HOUSE_ADDR2, HOUSE_ADDR3,
					  HOUSE_TOTAL_PERSONS, HOUSE_PERSONS, HOUSE_TOTAL_PRICE, HOUSE_PRICE, 
					  HOUSE_PERSON_PRICE, HOUSE_CNT, MEMBER_IDX 
			FROM HOUSE 
			ORDER BY HOUSE_IDX DESC
		]]>
	</select>
	<!-- house Map 리스트 뽑기 idx, addr1 필요 -->
	<select id="selectHouseMapList" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
			SELECT HOUSE_IDX, HOUSE_ADDR1 
			FROM HOUSE 
			ORDER BY HOUSE_IDX DESC
		]]>
	</select>
	
	<select id="searchHouseList" parameterType="hashmap" resultType="hashmap">
		
		SELECT distinct HOUSE_IDX, HOUSE_NAME, HOUSE_INFO, HOUSE_IMAGE, HOUSE_PRICE, MEMBER_IDX 
		FROM (Select H.HOUSE_IDX,HOUSE_NAME, HOUSE_INFO, HOUSE_IMAGE, HOUSE_PRICE, H.MEMBER_IDX 
				From HOUSE H Left Join HOUSE_RSV RSV on H.HOUSE_IDX = RSV.HOUSE_IDX 				
					
			<where>
				<if test="preSearch_keyword != null">
					(HOUSE_NAME like '%'||#{preSearch_keyword}||'%' or HOUSE_INFO like '%' || #{preSearch_keyword} || '%' 
					or HOUSE_ADDR1 like '%' || #{preSearch_keyword} || '%' or HOUSE_ADDR2 like '%' || #{preSearch_keyword} || '%' 
					or HOUSE_ADDR3 like '%' || #{preSearch_keyword} || '%')
				</if>
				<if test="person != null">
					<![CDATA[AND ( #{person} <= HOUSE_TOTAL_PERSONS)]]>
				</if> 
			</where>
			<if test="hr_first_date != null and hr_last_date != null">
				minus
					(select H.HOUSE_IDX,HOUSE_NAME, HOUSE_INFO, HOUSE_IMAGE, HOUSE_PRICE, H.MEMBER_IDX  
					From HOUSE H Left Join HOUSE_RSV RSV on H.HOUSE_IDX = RSV.HOUSE_IDX 
					where <![CDATA[((HR_FIRST_DATE <= TO_DATE(#{hr_first_date}, 'mm/dd/yyyy') and TO_DATE(#{hr_first_date}, 'mm/dd/yyyy') < HR_LAST_DATE) 
								OR (HR_FIRST_DATE <= TO_DATE(#{hr_last_date}, 'mm/dd/yyyy') and  TO_DATE(#{hr_last_date}, 'mm/dd/yyyy') < HR_LAST_DATE))]]>
					)
			</if>	
			
			ORDER BY HOUSE_IDX DESC)
			
	</select>
	
	
	<!-- House Detail -->
	<select id="selectHouseDetail" parameterType="hashmap" resultType="hashmap">
			SELECT H.HOUSE_IDX, HOUSE_NAME, HOUSE_INFO, HOUSE_IMAGE,
					 HOUSE_KIND, HOUSE_ZIPCODE, HOUSE_ADDR1, HOUSE_ADDR2, HOUSE_ADDR3,
					  HOUSE_TOTAL_PERSONS, HOUSE_PERSONS, HOUSE_TOTAL_PRICE, HOUSE_PRICE, 
					  HOUSE_PERSON_PRICE, HOUSE_CNT, MEMBER_IDX, 
					HI_IDX, HI_CLEAN_PRICE, HI_DEPOSIT, HI_GUEST, HI_SPACE, HI_CSPACE, HI_BAD, HI_ROOM,
				   HI_CHECKIN, HI_CHECKOUT, HI_TOTAL_STAR
			FROM HOUSE H 
						LEFT JOIN HOUSE_INFO HI on H.HOUSE_IDX = HI.HOUSE_IDX
			WHERE H.HOUSE_IDX = #{HOUSE_IDX}
			ORDER BY H.HOUSE_IDX DESC
	</select>
	
	<select id="selectReviewList" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
			SELECT HRB_IDX, HRB_TITLE, HRB_CONTENT, HRB_PWD, HRB_REGDATE, HRB_STAR, HRB_LIKE, MEMBER_IDX, HOUSE_IDX
			FROM HOUSE_REVIEW_BOARD
			WHERE HOUSE_IDX = #{HOUSE_IDX}
			ORDER BY HRB_IDX DESC
		]]>
	</select>
	
	<!-- house insert sql -->
	<insert id="insertHouse" parameterType="hashmap" useGeneratedKeys="true" keyProperty="HOUSE_IDX">
		<selectKey keyProperty="HOUSE_IDX" resultType="string" order="BEFORE">
			SELECT HOUSE_IDX_SEQ.NEXTVAL FROM DUAL
		</selectKey>
	<!-- HOUSE_IDX_SEQ.NEXTVAL -->
	<![CDATA[
		INSERT INTO HOUSE(
			HOUSE_IDX, HOUSE_NAME, HOUSE_INFO, HOUSE_KIND, 
			HOUSE_ZIPCODE, HOUSE_ADDR1, HOUSE_ADDR2, HOUSE_ADDR3, 
			HOUSE_TOTAL_PERSONS, HOUSE_PERSON_PRICE, 
			HOUSE_PRICE, HOUSE_IMAGE
	    )VALUES(
			#{HOUSE_IDX}, #{HOUSE_NAME}, #{HOUSE_INFO}, #{HOUSE_KIND}, 
			#{HOUSE_ZIPCODE}, #{HOUSE_ADDR1}, #{HOUSE_ADDR2}, #{HOUSE_ADDR3},
			#{HOUSE_TOTAL_PERSONS}, #{HOUSE_PERSON_PRICE}, 
			#{HOUSE_PRICE}, #{HOUSE_IMAGE}
		)
	]]>
	</insert>
	<!-- 
	UPDATE HOUSE_INFO SET HI_CHECKOUT = SYSDATE
WHERE HI_IDX = 240
ALTER TABLE HOUSE_INFO
MODIFY(HI_CHECKIN DATE, HI_CHECKOUT DATE)
	 -->
	<!-- houseInfo insert sql -->
	<insert id="insertHouseInfo" parameterType="hashmap">
		<![CDATA[
			INSERT INTO HOUSE_INFO(
				HI_IDX, HOUSE_IDX, HI_SALE, HI_DEPOSIT, HI_GUEST, 
				HI_SPACE, HI_CSPACE, HI_BAD, HI_ROOM, HI_CLEAN_PRICE, 
				HI_CHECKIN, HI_CHECKOUT
			)VALUES(
				HI_IDX_SEQ.NEXTVAL, #{HOUSE_IDX}, #{HI_SALE}, #{HI_DEPOSIT}, 
				#{HI_GUEST}, #{HI_SPACE}, #{HI_CSPACE}, #{HI_BAD}, #{HI_ROOM}, #{HI_CLEAN_PRICE},
				#{HI_CHECKIN}, #{HI_CHECKOUT}
				)		
		]]>
	</insert>
	
	<insert id="insertHouseImg" parameterType="hashmap">
		<![CDATA[
			INSERT INTO HOUSE(
			HOUSE_IMAGE
			)VALUES(
			#{HOUSE_IMAGE}
			)
		]]>
	</insert>
	
	<insert id="insertReview" parameterType="hashmap">
		INSERT INTO HOUSE_REVIEW_BOARD (
		 	HRB_IDX, HRB_TITLE, HRB_CONTENT, <!-- HRB_PWD, --> HRB_REGDATE, <!-- HRB_STAR, HRB_LIKE, --> MEMBER_IDX, HOUSE_IDX
		 ) VALUES (
		 	hrb_idx_seq.nextval, #{HRB_TITLE}, #{HRB_CONTENT}, <!-- #{HRB_PWD} --> #{HRB_REGDATE},<!--  #{HRB_STAR}, #{HRB_LIKE}, --> #{MEMBER_IDX}, #{HOUSE_IDX}
		 )
	</insert>
</mapper>